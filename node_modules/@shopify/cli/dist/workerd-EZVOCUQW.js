import {
  H2O_BINDING_NAME,
  SUBREQUEST_PROFILER_ENDPOINT,
  TUNNEL_DOMAIN,
  createLogRequestEvent,
  getDebugBannerLine,
  getUtilityBannerlines,
  handleDebugNetworkRequest,
  handleMiniOxygenImportFail,
  importLocal,
  logRequestLine,
  setConstructors
} from "./chunk-2Q7SKRRM.js";
import {
  AbortError,
  createFileReadStream,
  dirname,
  outputNewline,
  readFile,
  renderSuccess,
  resolvePath
} from "./chunk-2RKUO75O.js";
import "./chunk-UJQBYPRO.js";
import "./chunk-LAY4AEXX.js";
import "./chunk-4XNS74OG.js";
import "./chunk-CKKROMZF.js";
import "./chunk-LKGDG6WW.js";
import "./chunk-QX3YP6O5.js";
import "./chunk-HTYJDJRZ.js";
import "./chunk-7YJH7P7B.js";
import "./chunk-FAFQQMD4.js";
import {
  source_default
} from "./chunk-LUGC3D2G.js";
import "./chunk-FQIRJADJ.js";
import "./chunk-FBB6KUZG.js";
import "./chunk-SZQX5J7X.js";
import "./chunk-67MDUPX5.js";
import "./chunk-PBFWVFAQ.js";
import "./chunk-FWGRGI4R.js";
import "./chunk-BE73NZXB.js";
import "./chunk-VQZ2SHRY.js";
import "./chunk-6SL33DOA.js";
import "./chunk-WCNR75S2.js";
import "./chunk-3PIGYQSE.js";
import "./chunk-BZJX2NV6.js";
import "./chunk-RQ24VTW4.js";
import "./chunk-3JLUTHGR.js";
import "./chunk-GXPKATXW.js";
import {
  init_cjs_shims
} from "./chunk-M63RTPGR.js";

// ../../node_modules/.pnpm/@shopify+cli-hydrogen@0.0.0-next-ca7f288-20240530103543_react-dom@17.0.2_react@17.0.2/node_modules/@shopify/cli-hydrogen/dist/lib/mini-oxygen/workerd.js
init_cjs_shims();
import { createRequire } from "node:module";
async function startWorkerdServer({
  root,
  appPort,
  inspectorPort: publicInspectorPort,
  assetsPort,
  debug = false,
  watch = false,
  buildPathWorkerFile,
  buildPathClient,
  env
}) {
  const { createMiniOxygen, Response } = await importLocal(
    "@shopify/mini-oxygen",
    root
  ).catch(handleMiniOxygenImportFail);
  setConstructors({ Response });
  async function handleCustomerAccountSchema() {
    const require2 = createRequire(import.meta.url);
    const filePath = require2.resolve(
      "@shopify/hydrogen/customer-account.schema.json"
    );
    return new Response(createFileReadStream(filePath), {
      headers: { "Content-Type": "application/json" }
    });
  }
  const mainWorkerName = "hydrogen";
  const absoluteBundlePath = resolvePath(root, buildPathWorkerFile);
  const readWorkerFile = () => readFile(absoluteBundlePath).catch((error) => {
    throw new AbortError(
      `Could not read worker file.

` + error.stack,
      "Did you build the project?"
    );
  });
  const miniOxygen = createMiniOxygen({
    debug,
    port: appPort,
    host: "localhost",
    liveReload: watch,
    requestHook: logRequestLine,
    inspectorPort: publicInspectorPort,
    inspectWorkerName: mainWorkerName,
    assets: { port: assetsPort, directory: buildPathClient },
    workers: [
      {
        name: "hydrogen:middleware",
        modules: true,
        script: `export default { fetch: (request, env) => {
          const url = new URL(request.url);
          if (url.hostname.endsWith('${TUNNEL_DOMAIN.ORIGINAL}')) {
            url.hostname = url.hostname.replace(
              '${TUNNEL_DOMAIN.ORIGINAL}',
              '${TUNNEL_DOMAIN.REBRANDED}',
            );
          }

          return url.pathname === '${SUBREQUEST_PROFILER_ENDPOINT}'
            ? env.profiler.fetch(url, request)
            : url.pathname === '/graphiql/customer-account.schema.json'
            ? env.assets.fetch(url, request)
            : env.next.fetch(url, request)
          }
        }`,
        serviceBindings: {
          profiler: handleDebugNetworkRequest,
          assets: handleCustomerAccountSchema,
          next: mainWorkerName
        }
      },
      {
        name: mainWorkerName,
        modulesRoot: dirname(absoluteBundlePath),
        modules: [
          {
            type: "ESModule",
            path: absoluteBundlePath,
            contents: await readWorkerFile()
          }
        ],
        bindings: { ...env },
        serviceBindings: {
          [H2O_BINDING_NAME]: createLogRequestEvent({
            transformLocation: () => absoluteBundlePath
          })
        }
      }
    ]
  });
  const { workerUrl, inspectorUrl } = await miniOxygen.ready;
  return {
    port: Number(workerUrl.port),
    listeningAt: workerUrl.origin,
    reload(nextOptions) {
      return miniOxygen.reload(async ({ workers }) => {
        const mainWorker = workers.find(({ name }) => name === mainWorkerName);
        if (Array.isArray(mainWorker.modules) && mainWorker.modules[0]) {
          mainWorker.modules[0].contents = await readWorkerFile();
        }
        if (nextOptions) {
          mainWorker.bindings = { ...nextOptions?.env ?? env };
        }
        return { workers };
      });
    },
    showBanner(options) {
      outputNewline();
      const customSections = [];
      if (options?.host) {
        customSections.push({ body: getUtilityBannerlines(options.host) });
      }
      if (inspectorUrl) {
        customSections.push({
          body: { warn: getDebugBannerLine(Number(inspectorUrl.port)) }
        });
      }
      renderSuccess({
        headline: `${options?.headlinePrefix ?? ""}MiniOxygen (Worker Runtime) ${options?.mode ?? "development"} server running.`,
        body: [
          `View ${options?.appName ? source_default.cyan(options?.appName) : "Hydrogen"} app:`,
          { link: { url: options?.host || workerUrl.origin } }
        ],
        customSections
      });
      console.log("");
    },
    async close() {
      await miniOxygen.dispose();
    }
  };
}
export {
  startWorkerdServer
};
